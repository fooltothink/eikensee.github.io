<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EIKEN Pre-1: Voice Narrator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=JetBrains+Mono&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .font-mono { font-family: 'JetBrains+Mono', monospace; }
        
        .mic-active { animation: pulse 1.5s infinite; }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        .correct-flash { animation: flash 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes flash {
            0% { background-color: transparent; }
            30% { background-color: #dcfce7; transform: scale(1.02); }
            100% { background-color: transparent; transform: scale(1); }
        }

        .score-pop { animation: scorePop 0.5s ease-out; }
        @keyframes scorePop {
            0% { transform: scale(1); color: #facc15; }
            50% { transform: scale(1.4); color: #ffffff; }
            100% { transform: scale(1); color: #facc15; }
        }

        .word-entrance { animation: slideIn 0.3s ease-out forwards; opacity: 0; }
        @keyframes slideIn {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-opening { animation: fadeInDown 0.7s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen p-4">

<div id="app" class="max-w-3xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200 mt-4">
    <!-- UI injected by JS -->
</div>

<script>
const SCENARIOS = [
    {
        id: 'warmup',
        title: 'Warm-up: The SEE Logic',
        openingSentence: "One day, some events happened in a logical order.",
        panels: [
            { id: 'w1', title: 'The Late Arrival', s: "The man arrived at the station.", e: "He felt anxious and looked at his clock.", ex: "This was because he missed the important meeting." },
            { id: 'w2', title: 'The New Project', s: "The boss praised the employee for her hard work.", e: "She looked very satisfied and proud.", ex: "Because the long project had finally been completed." },
            { id: 'w3', title: 'The Rainy Day', s: "It was suddenly raining heavy outside.", e: "She looked frustrated as she stood on the street.", ex: "This was because she had left her umbrella at home." }
        ]
    },
    {
        id: 'day1',
        title: 'Day 1: The Farming Experience',
        openingSentence: "One day, a woman was watching a television program.",
        panels: [
            { id: 'd1p1', title: 'The Television Program', s: "There was a program about a campaign inviting viewers to join a farming experience.", e: "The woman seemed really interested in the program.", ex: "This was because she pictured herself working hard on a farm." },
            { id: 'd1p2', title: 'A Month Later', s: "The woman went to a farm and stood in a field with other participants.", e: "She and the others listened attentively to a professional farmer.", ex: "He was explaining the correct way to harvest potatoes." },
            { id: 'd1p3', title: 'An Hour Later', s: "Everyone was digging up potatoes in the field.", e: "They were enjoying themselves despite the hard work.", ex: "The woman remarked that the experience was more fun than she had expected." },
            { id: 'd1p4', title: 'The Next Morning', s: "The woman was back at her office at 11:00 am.", e: "She looked exhausted and was struggling to finish her work.", ex: "This was because her body felt the physical toll of the manual labor from the day before." }
        ]
    },
    {
        id: 'day2',
        title: 'Day 2: The Casino Job',
        openingSentence: "One day, a woman was looking for a job in her hometown.",
        panels: [
            { id: 'd2p1', title: 'The Closing Cafe', s: "She approached a caf√© owner to ask for a job, but he was holding a sign that said the caf√© was closing down.", e: "She noticed several other shops with 'FOR RENT' signs in their windows.", ex: "She felt disappointed because the local economy was struggling." },
            { id: 'd2p2', title: 'Two Weeks Later', s: "While she was reading a newspaper, she saw an advertisement for a new casino that was hiring staff.", e: "She looked hopeful as she wrote down the contact information.", ex: "This was because she decided to apply for the position." },
            { id: 'd2p3', title: 'Two Months Later', s: "The woman was working at the reception desk of the now-busy casino.", e: "She looked concerned and worried as she watched a customer staring into his empty wallet.", ex: "She realized that some people were spending too much money at the casino." },
            { id: 'd2p4', title: 'Later That Night', s: "She was walking along a dark street from the casino and saw a group of men talking loudly.", e: "She looked nervous as she hurried past the rowdy group.", ex: "She realized that the atmosphere of her neighborhood had changed since the casino opened." }
        ]
    },
    {
        id: 'day3',
        title: 'Day 3: Job-Hunting Student',
        openingSentence: "One day, a university student went job-hunting.",
        panels: [
            { id: 'd3p1', title: 'The Job Fair', s: "He attended a large JOB FAIR where a massive crowd of students had gathered.", e: "He looked surprised and overwhelmed by how many people were there.", ex: "Since there were no seats left, he was forced to stand at the back." },
            { id: 'd3p2', title: 'A Few Days Later', s: "While sitting in a caf√©, he was writing down company examination dates in his diary.", e: "He looked stressed as he compared the exam dates with his university schedule.", ex: "He realized that several exams overlapped with his classes." },
            { id: 'd3p3', title: 'A Month Later', s: "The student's professor asked one of his classmates why the young man was absent.", ex: "The classmate explained that the student was busy job-hunting lately." },
            { id: 'd3p4', title: 'Four Months Later', s: "The student was called into the professor's office.", e: "He looked shocked and worried when the professor told him it would be difficult to graduate.", ex: "His frequent absences from class had put his graduation at risk." }
        ]
    },
    {
        id: 'day4',
        title: 'Day 4: The Teleworking System',
        openingSentence: "One day, a man wearing glasses was going to his company on a crowded rush-hour train.",
        panels: [
            { id: 'd4p1', title: 'The Crowded Train', s: "The man was looking at his watch while standing among many other passengers.", e: "He looked worried about the time while others appeared uncomfortable.", ex: "This was because the train was packed, making his commute difficult." },
            { id: 'd4p2', title: 'Later at Work', s: "A notice was posted in his office announcing a new teleworking system.", e: "The man looked pleased as he read the announcement.", ex: "He decided to use the system so he would no longer travel on the train." },
            { id: 'd4p3', title: 'One Week Later', s: "The man was sitting in front of his computer at home, dressed in casual clothes.", e: "He looked relaxed and happy as he worked.", ex: "Because he was able to eat and drink in the comfort of his own home." },
            { id: 'd4p4', title: 'One Month Later', s: "The man was still working from home, but his hair had grown long.", e: "He looked somewhat unkempt as he sat in the middle of a messy room." }
        ]
    }
];

let state = {
    selectedScenario: SCENARIOS[0],
    currentPanelIndex: 0,
    currentType: 's',
    gameState: 'setup',
    shuffledWords: [],
    transcript: "",
    isListening: false,
    recognition: null,
    isCorrect: false,
    isRecognitionActive: false,
    audioContext: null,
    score: 0,
    isAnimatingScore: false
};

function playSound(type) {
    if (!state.audioContext) {
        state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
    const ctx = state.audioContext;
    if (ctx.state === 'suspended') ctx.resume();
    
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    const now = ctx.currentTime;

    if (type === 'success') {
        osc.type = 'sine';
        osc.frequency.setValueAtTime(523.25, now);
        osc.frequency.exponentialRampToValueAtTime(880, now + 0.1);
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
        osc.start(now);
        osc.stop(now + 0.3);
    } else if (type === 'fanfare') {
        const notes = [523.25, 659.25, 783.99, 1046.50];
        notes.forEach((note, i) => {
            const o = ctx.createOscillator();
            const g = ctx.createGain();
            o.connect(g);
            g.connect(ctx.destination);
            o.frequency.setValueAtTime(note, now + (i * 0.1));
            g.gain.setValueAtTime(0.1, now + (i * 0.1));
            g.gain.exponentialRampToValueAtTime(0.01, now + (i * 0.1) + 0.3);
            o.start(now + (i * 0.1));
            o.stop(now + (i * 0.1) + 0.3);
        });
    } else if (type === 'pop') {
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(150, now);
        osc.frequency.exponentialRampToValueAtTime(40, now + 0.1);
        gain.gain.setValueAtTime(0.05, now);
        gain.gain.linearRampToValueAtTime(0, now + 0.1);
        osc.start(now);
        osc.stop(now + 0.1);
    }
}

if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    state.recognition = new SpeechRecognition();
    state.recognition.continuous = true;
    state.recognition.interimResults = true;
    state.recognition.lang = 'en-US';

    state.recognition.onstart = () => {
        state.isRecognitionActive = true;
        render();
    };

    state.recognition.onresult = (event) => {
        if (state.isCorrect) return;
        let interimTranscript = '';
        for (let i = event.resultIndex; i < event.results.length; ++i) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
                state.transcript = transcript;
                checkSpeech();
            } else {
                interimTranscript += transcript;
            }
        }
        const liveEl = document.getElementById('live-transcript');
        if (liveEl) liveEl.innerText = interimTranscript || state.transcript;
    };

    state.recognition.onerror = (event) => {
        if (event.error === 'no-speech' || event.error === 'audio-capture') {
            state.isRecognitionActive = false;
        }
        render();
    };

    state.recognition.onend = () => {
        state.isRecognitionActive = false;
        if (state.isListening && state.gameState === 'playing' && !state.isCorrect) {
            startMicService();
        }
        render();
    };
}

async function startMicService() {
    if (state.recognition && !state.isRecognitionActive) {
        try { 
            state.recognition.start(); 
        } catch(e) {}
    }
}

function scramble(sentence) {
    return (sentence || "").split(' ').sort(() => Math.random() - 0.5);
}

function checkSpeech() {
    const rawTarget = state.selectedScenario.panels[state.currentPanelIndex][state.currentType];
    if (!rawTarget) return;

    const target = rawTarget.toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_~()]/g,"");
    const input = state.transcript.toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_~()]/g,"");
    
    const targetWords = target.split(/\s+/).filter(w => w.length > 2);
    const matchedWords = targetWords.filter(word => input.includes(word));
    const accuracy = targetWords.length > 0 ? (matchedWords.length / targetWords.length) : 1;

    if (accuracy > 0.60 || input.includes(target)) {
        state.isCorrect = true;
        state.score += 100;
        state.isAnimatingScore = true;
        playSound('success');
        render();
        setTimeout(() => {
            state.isAnimatingScore = false;
            handleSuccess();
        }, 1000);
    }
}

function render() {
    const app = document.getElementById('app');
    if (!app) return;
    
    if (state.gameState === 'setup') {
        app.innerHTML = `
            <div class="bg-slate-900 p-6 text-white flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-extrabold flex items-center gap-2">
                        <span class="text-indigo-400">üèÜ</span> SEE Voice Narrator
                    </h1>
                    <p class="text-slate-400 text-sm font-medium italic">EIKEN Pre-1 Mastery</p>
                </div>
                <div class="bg-slate-800 px-4 py-1 rounded-full text-yellow-400 font-mono text-sm border border-slate-700">
                    High Score: ${localStorage.getItem('see_highscore') || 0}
                </div>
            </div>
            <div class="p-8 space-y-6">
                <section>
                    <h3 class="text-xs font-black text-slate-400 mb-4 uppercase tracking-widest">Select Scenario</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        ${SCENARIOS.map(s => `
                            <button onclick="selectScenario('${s.id}')" class="p-4 rounded-2xl border-2 text-left transition-all hover:scale-[1.02] active:scale-95 ${state.selectedScenario.id === s.id ? 'border-indigo-500 bg-indigo-50 text-indigo-700 shadow-md' : 'border-slate-100 hover:border-slate-200'}">
                                <div class="font-bold">${s.title}</div>
                                <div class="text-xs opacity-60">${s.panels.length} panels</div>
                            </button>
                        `).join('')}
                    </div>
                </section>
                <button onclick="startGame()" class="w-full bg-indigo-600 text-white py-5 rounded-2xl font-black text-xl hover:bg-indigo-700 shadow-lg transition-all transform active:translate-y-1">
                    START LESSON
                </button>
            </div>
        `;
    } else if (state.gameState === 'playing') {
        const panel = state.selectedScenario.panels[state.currentPanelIndex];
        const opening = (state.currentPanelIndex === 0 && state.selectedScenario.openingSentence) ? 
            `<div class="mb-6 p-4 bg-indigo-50 border-l-4 border-indigo-500 text-indigo-900 font-bold italic rounded-r-lg text-sm animate-opening">
                "${state.selectedScenario.openingSentence}"
            </div>` : '';

        app.innerHTML = `
            <div class="bg-slate-900 p-6 text-white flex justify-between items-center transition-all ${state.isCorrect ? 'correct-flash' : ''}">
                <div>
                    <h1 class="text-lg font-bold truncate max-w-[220px]">${state.selectedScenario.title}</h1>
                    <p class="text-slate-400 text-xs font-medium">${panel.title}</p>
                </div>
                <div class="flex flex-col items-end">
                    <div class="text-xs font-black uppercase tracking-widest text-slate-500 mb-1">Score</div>
                    <div class="text-2xl font-mono font-bold text-yellow-400 ${state.isAnimatingScore ? 'score-pop' : ''}">${state.score}</div>
                </div>
            </div>
            
            <div class="p-8">
                ${opening}

                <div class="flex justify-between items-center mb-8">
                    <div class="flex gap-1.5">
                        ${['s', 'e', 'ex'].map(t => `
                            <div class="h-1.5 w-10 rounded-full ${state.currentType === t ? 'bg-indigo-500' : 'bg-slate-200'} transition-all duration-300"></div>
                        `).join('')}
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-2.5 h-2.5 rounded-full ${state.isRecognitionActive ? 'bg-red-500 mic-active' : 'bg-slate-300'}"></div>
                        <span class="text-[10px] font-black uppercase tracking-widest text-slate-400">${state.isRecognitionActive ? 'Listening' : 'Ready'}</span>
                    </div>
                </div>

                <div class="min-h-[260px] flex flex-col items-center justify-center space-y-12">
                    <div class="flex flex-wrap justify-center gap-2.5">
                        ${state.shuffledWords.map((word, i) => `
                            <span class="px-5 py-3 bg-white text-slate-800 rounded-2xl font-bold border-2 border-slate-100 shadow-sm text-lg select-none word-entrance" style="animation-delay: ${i * 0.05}s">
                                ${word}
                            </span>
                        `).join('')}
                    </div>

                    <div id="live-transcript" class="text-center text-indigo-500 italic text-xl h-10 px-4 font-bold max-w-sm">
                        ${state.transcript || 'Speak the sentence...'}
                    </div>

                    ${state.isCorrect ? `
                        <div class="text-green-600 font-black text-3xl animate-bounce tracking-widest">EXCELLENT!</div>
                    ` : ''}
                </div>

                <div class="mt-8 flex justify-between items-center border-t border-slate-100 pt-6">
                    <div class="text-[10px] font-black text-slate-300 uppercase tracking-widest">
                        Panel ${state.currentPanelIndex + 1} of ${state.selectedScenario.panels.length}
                    </div>
                    <button onclick="handleSuccess()" class="text-xs text-slate-300 hover:text-indigo-500 underline font-black uppercase tracking-tighter">
                        Skip
                    </button>
                </div>
            </div>
        `;
    } else if (state.gameState === 'result') {
        app.innerHTML = `
            <div class="p-16 text-center animate-in zoom-in duration-500">
                <div class="text-8xl mb-8">üéä</div>
                <h2 class="text-4xl font-black text-slate-900 mb-2 tracking-tighter italic uppercase">Mastery!</h2>
                <p class="text-slate-500 mb-10 font-medium">Scenario complete with a score of ${state.score}.</p>
                <div class="bg-indigo-600 text-white p-8 rounded-3xl mb-10 inline-block shadow-xl">
                    <div class="text-xs font-black uppercase tracking-widest opacity-80 mb-1">Final Score</div>
                    <div class="text-6xl font-mono font-black">${state.score}</div>
                </div>
                <div>
                    <button onclick="resetGame()" class="px-12 py-4 bg-slate-900 text-white rounded-2xl font-black text-lg hover:bg-slate-800 shadow-lg">
                        MAIN MENU
                    </button>
                </div>
            </div>
        `;
    }
}

function selectScenario(id) {
    state.selectedScenario = SCENARIOS.find(s => s.id === id);
    state.currentPanelIndex = 0;
    state.currentType = 's';
    render();
}

function startGame() {
    state.gameState = 'playing';
    state.isCorrect = false;
    state.transcript = "";
    state.score = 0;
    state.shuffledWords = scramble(state.selectedScenario.panels[0].s);
    state.isListening = true;
    startMicService();
    render();
}

function handleSuccess() {
    state.isCorrect = false;
    state.transcript = ""; 
    
    const panel = state.selectedScenario.panels[state.currentPanelIndex];
    if (state.currentType === 's') {
        state.currentType = panel.e ? 'e' : 'ex';
    } else if (state.currentType === 'e') {
        state.currentType = panel.ex ? 'ex' : 's';
        if (state.currentType === 's') state.currentPanelIndex++;
    } else {
        state.currentPanelIndex++;
        state.currentType = 's';
    }
    
    if (state.currentPanelIndex >= state.selectedScenario.panels.length) {
        state.gameState = 'result';
        state.isListening = false;
        playSound('fanfare');
        if (state.recognition) state.recognition.stop();
        
        const currentHigh = parseInt(localStorage.getItem('see_highscore') || 0);
        if (state.score > currentHigh) localStorage.setItem('see_highscore', state.score);
    } else {
        const nextPanel = state.selectedScenario.panels[state.currentPanelIndex];
        state.shuffledWords = scramble(nextPanel[state.currentType]);
        playSound('pop');
    }
    render();
}

function resetGame() {
    state.gameState = 'setup';
    state.currentPanelIndex = 0;
    state.currentType = 's';
    state.isListening = false;
    if (state.recognition) state.recognition.stop();
    render();
}

render();
</script>
</body>
</html>
